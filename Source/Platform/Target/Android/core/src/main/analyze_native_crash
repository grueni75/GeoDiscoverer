#!/usr/bin/perl
use Data::Dumper;
use MIME::Base64;

# Get args
die "Usage: analyze_native_crash.pl <html report saved as text in firefox | binary crash dump>" if (@ARGV != 1);
my $report = shift;
my $lib = shift;

# Extract the breakpad dump
my $dump = "";
my $arch = "armeabi-v7a";
if ($report !~ m/.dmp$/) {
  print "Extracting native dump from crash report... ";
  open(my $in, $report) or die "Can not open <$report> for reading!";
  my $state = 0;
  while (my $line = <$in>) {
    chomp $line;
    #print $line . "\n";
    if ($state==0) {
      $state=1 if ($line eq 'APPLICATION_LOG');
    } elsif ($state==1) {
      $state=2 if ($line =~ m/index\s*value/);
    } elsif ($state==2) {
      if ($line =~ m/^\d+\s*(.*)$/) {
        #print $1 . "\n";
        if ($1 ne "") {
          $dump = $dump . $1 . "\n";
        } else {
          $state=3;
        }
      } else {
        $state=4;
      } 
    } elsif ($state==3) {
      $dump = $dump . $line . "\n";
      $state=2;
    } elsif ($state==4) {
      if ($line =~ m/CPU_ABI\s*(\S*)/) {
        $arch = $1;
        last;
      }
    }
    #print $state . "\n";
  }
  close($in);
  #print $dump;
  print "Done!\n";
}

# Translate the cpu architecture
#print $arch . "\n";
if ($arch eq 'armeabi-v7a') {
  $arch='arm-v7a';
} elsif ($arch eq 'armeabi') {
  $arch='arm';
} else {
  die "CPU architecture $arch not supported!";
}
#print $arch . "\n";

# Decode the dump and write it to disk
if ($report !~ m/.dmp$/) {
  print "Decoding native dump... ";
  #print($dump);
  my $decoded_dump = decode_base64($dump);
  open (my $out, ">/tmp/crash.bin") or die "Can not open </tmp/crash.dmp> for writing!";
  print $out $decoded_dump;
  close($out);
  print "Done!\n";
} else {
  system("cp \"" . $report . "\" /tmp/crash.bin");
}

# Check if the bin file is a zip file
my $status = system("unzip -t /tmp/crash.bin >/dev/null");
if ($status == 0) {
  print "Extracting log files to /tmp/crash...\n";
  system("rm -rf /tmp/crash >/dev/null 2>&1");
  mkdir "/tmp/crash";
  system("cd /tmp/crash/; unzip /tmp/crash.bin");
  system("cp /tmp/crash/crash.dmp /tmp/crash.bin");
}
 
# Output the stack trace
system("minidump_stackwalk /tmp/crash.bin sym/$arch 2>/dev/null");


